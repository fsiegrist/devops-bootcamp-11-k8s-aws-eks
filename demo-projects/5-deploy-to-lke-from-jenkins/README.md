## Demo Project - Deploy to LKE cluster from Jenkins Pipeline

### Topics of the Demo Project
CD - Deploy to LKE cluster from Jenkins Pipeline

### Technologies Used
- Kubernetes
- Jenkins
- Linode LKE
- Docker
- Linux

### Project Description
- Create K8s cluster on LKE
- Add LKE credentials (kubeconfig) on Jenkins
- Install the Kubernetes CLI Jenkins plugin
- Adjust Jenkinsfile to use the plugin and deploy to LKE cluster

#### Steps to create K8s cluster on LKE
- We login to our Linode Management Console, navigate to Kubernetes and press the "Create Cluster" button.
- Enter a cluster label (e.g. test-cluster), select a region (e.g. Frankfurt eu-central) and the latest K8s version (e.g. 1.26).
- Select the "Shared CPU" tab, add one Linode 2 GB node and press "Create Cluster".
- As soon as the cluster is up and running (this will take just a few moments), we download the kubeconfig file `test-cluster-kubeconfig.yaml` that was autogenerated for us.

Right now kubectl is probably still connecting to the EKS cluster we worked with in the last demo project (using the default kubeconfig file path `~/.kube/config`). To let kubectl use another config file, we just set the environment variable 'KUBECONFIG' to the path of that other config file:
```sh
export KUBECONFIG=~/Downloads/test-cluster-kubeconfig.yaml

# check the connection
kubectl get nodes
# NAME                            STATUS   ROLES    AGE     VERSION
# lke109401-163296-6468ac4fc9f0   Ready    <none>   7m16s   v1.26.3
```

#### Steps to add LKE credentials (kubeconfig) on Jenkins
- We login to our Jenkins account (running on DigitalOcean) and navigate to Dashboard > devops-bootcamp-multibranch-pipeline > Credentials > devops-bootcamp-multibranch-pipeline > Global credentials (unrestricted) and press the "Add Credentials" button.
- Select the Kind 'Secret file' and upload the `~/Downloads/test-cluster-kubeconfig.yaml` file from our local machine.
- Enter 'lke-credentials' in the 'ID' text field and press the "Create" button.

#### Steps to install the Kubernetes CLI Jenkins Plugin
Navigate to Dashboard > Manage Jenkins > Manage Plugins > Available plugins. Search for "Kubernetes CLI", select the plugin in press "Install without restart".

#### Steps to adjust Jenkinsfile to use the plugin and deploy to LKE cluster
We switch to the sample application 'java-maven-app' and create a new branch 'deploy-on-lke'. We open the Jenkinsfile and replace its content with the following:
```groovy
#!/usr/bin/env groovy

pipeline {
    agent any
    stages {
        stage('build app') {
            steps {
               script {
                   echo "building the application..."
               }
            }
        }
        stage('build image') {
            steps {
                script {
                    echo "building the docker image..."
                }
            }
        }
        stage('deploy') {
            steps {
                script {
                   echo 'deploying docker image...'
                   withKubeConfig([credentialsId: 'lke-credentials', serverUrl: 'https://494dfb55-c0f3-4517-8104-63c0c13639e2.eu-central-1.linodelke.net']) {
                       sh 'kubectl create deployment nginx-deployment --image=nginx'
                   }
                }
            }
        }
    }
}
```

Compared to deploying to AWS EKS cluster, we don't need additional platform authentication configuration. We just use the Kubernetes CLI plugin (`withKubeConfig`) to let the `kubectl` command use the uploaded kubeconfig file.

We add, commit and push the new branch to the Git repository. If we have configured the multibranch pipeline on Jenkins to build all branches, the new branch will be automatically detected, a new pipeline will be created and the build will be automatically started.

After it has successfully finished, we open a terminal on our local machine and check the deployment:
```sh
kubectl get pods -o wide
# NAME                                READY   STATUS    RESTARTS   AGE   IP         NODE                            NOMINATED NODE   READINESS GATES
# nginx-deployment-55888b446c-cblwv   1/1     Running   0          10s   10.2.0.6   lke109401-163296-6468ac4fc9f0   <none>           <none>
```